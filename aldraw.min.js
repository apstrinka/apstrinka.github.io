"use strict";String.prototype.endsWith||(String.prototype.endsWith=function(t,e){var n=this.toString();("number"!=typeof e||!isFinite(e)||Math.floor(e)!==e||e>n.length)&&(e=n.length),e-=t.length;var i=n.lastIndexOf(t,e);return-1!==i&&i===e});var AlDrawModule=function(){var t={defaultTolerance:1e-5,isBetween:function(t,e,n){return t<=e+this.defaultTolerance&&t>=n-this.defaultTolerance||t>=e-this.defaultTolerance&&t<=n+this.defaultTolerance},floatsEqual:function(t,e){return!Number.isFinite(t)&&!Number.isFinite(e)||Math.abs(t-e)<this.defaultTolerance},round:function(t,e){var n=Math.pow(10,-e);return Math.round(t*n)/n},midPoint:function(t,e){return new n((t.x+e.x)/2,(t.y+e.y)/2)},perpendicularSlope:function(e){var n=Number.POSITIVE_INFINITY;return t.floatsEqual(e,0)||(n=-1/e),n},comparePointToLine:function(e,n){var i=n.getSlope(),s=n.getIntercept(),o=0;if(Number.isFinite(i)){var r=i*e.x+s;o=t.floatsEqual(e.y,r)?0:e.y>r?1:-1}else o=t.floatsEqual(e.x,s)?0:e.x>s?1:-1;return o},normalizeAngle:function(t){var e=t%(2*Math.PI);return e<0&&(e+=2*Math.PI),this.floatsEqual(e,2*Math.PI)&&(e=0),e},angleSum:function(e,n){var i=e+n;return t.normalizeAngle(i)},angleDifference:function(e,n){var i=e-n;return i=t.normalizeAngle(i)},smallerAngleDifference:function(e,n){return Math.min(t.angleDifference(e,n),t.angleDifference(n,e))},oppositeAngle:function(e){return t.angleSum(e,Math.PI)},angleToSlope:function(e){var n=Math.tan(e);return(t.floatsEqual(e,Math.PI/2)||t.floatsEqual(e,3*Math.PI/2))&&(n=Number.POSITIVE_INFINITY),n},slopeToAngle:function(e){var n=Math.atan(e);return n=t.normalizeAngle(n)},toRadians:function(t){return t*Math.PI/180},toDegrees:function(t){return 180*t/Math.PI},arrayContains:function(t,e){for(var n=t.length,i=0;i<n;i++)if(e.equals(t[i]))return!0;return!1},arrayIndexOf:function(t,e,n){void 0===n&&(n=0);for(var i=t.length,s=n;s<i;s++)if(e.equals(t[s]))return s;return-1},arrayLastIndexOf:function(t,e){for(var n=t.length-1;n>=0;n--)if(e.equals(t[n]))return n;return-1}};function e(t,e,n){this.red=t,this.green=e,this.blue=n}function n(t,e){this.x=t,this.y=e}function i(e,n,i,s){var o,r,a=e.comparePathableTo(i),c=e.comparePathableTo(s);if(a===n&&c!==n)return-1;if(c===n&&a!==n)return 1;var l=e.distanceAlong(i),h=e.distanceAlong(s),u=e.angleDifference(i);-1===a&&t.floatsEqual(u,0)&&(u=2*Math.PI);var d=e.angleDifference(s);return-1===c&&t.floatsEqual(d,0)&&(d=2*Math.PI),a===n?t.floatsEqual(l,h)?t.floatsEqual(u,d)?(o=i.curvature(),r=s.curvature(),t.floatsEqual(o,r)?0:o>r?-n:n):u>d?-n:n:l<h?-1:1:t.floatsEqual(l,h)?t.floatsEqual(u,d)?(o=i.curvature(),r=s.curvature(),t.floatsEqual(o,r)?0:o>r?-n:n):u>d?-n:n:l<h?1:-1}e.prototype.toString=function(){return"rgb("+this.red+","+this.green+","+this.blue+")"},e.prototype.darker=function(){return new e(4*this.red/5,4*this.green/5,4*this.blue/5)},n.fromObject=function(t){return new n(t.x,t.y)},n.prototype.dist=function(t){return Math.hypot(this.x-t.x,this.y-t.y)},n.prototype.angle=function(e){var n=Math.atan2(e.y-this.y,e.x-this.x);return n=t.normalizeAngle(n)},n.prototype.translate=function(t,e){return new n(this.x+t,this.y+e)},n.prototype.rotateAroundOrigin=function(t){return new n(Math.cos(t)*this.x-Math.sin(t)*this.y,Math.sin(t)*this.x+Math.cos(t)*this.y)},n.prototype.equals=function(e){return t.floatsEqual(this.x,e.x)&&t.floatsEqual(this.y,e.y)},n.prototype.draw=function(t,n,i){void 0===i&&(i=new e(0,255,0));var s=n.abstractToScreenCoord(this),o=t.fillStyle;t.fillStyle=i.darker().toString(),t.beginPath(),t.arc(s.x,s.y,tt.dotRadius,0,2*Math.PI),t.fill(),t.fillStyle=i.toString(),t.beginPath(),t.arc(s.x,s.y,tt.dotRadius/2,0,2*Math.PI),t.fill(),t.fillStyle=o};var s={intersect:function(t){return t.isA("AbstractLine")?this.intersectLine(t):t.isA("Circle")?this.intersectCircle(t):void console.log("This should never happen")},angleDifference:function(e){var n=this.angleAtPoint(e.startPoint()),i=e.angleAtStart();return t.angleDifference(i,n)},comparePathableTo:function(e){var n=this.angleDifference(e);return t.floatsEqual(n,0)?t.floatsEqual(e.curvature(),this.curvature())?0:e.curvature()<this.curvature()?-1:1:t.floatsEqual(n,Math.PI)?t.floatsEqual(e.curvature(),-this.curvature())?0:e.curvature()<-this.curvature()?1:-1:n<Math.PI?1:-1},comparePointTo:function(t){var e=new c(this.closestPoint(t),t);return this.comparePathableTo(e)},getIntersectionsInOrder:function(e,n){for(var s=[],o=(g=n.getPathables()).length,r=0;r<o;r++)for(var a=g[r],c=this.intersect(a),l=0;l<c.length;l++)if(null!==c[l]&&!c[l].equals(this.startPoint()))for(var u=a.divide(c[l]),d=0;d<u.length;d++)(this.canSwitchSides()||this.comparePathableTo(u[d])===e)&&s.push(u[d]);var p=this;if(s.sort(function(t,n){return i(p,e,t,n)}),this.isA("arc")&&t.floatsEqual(this.sweep,2*Math.PI)){var f=[],g=n.getPathables();for(r=0;r<g.length;r++)for(a=g[r],c=this.intersect(a),l=0;l<c.length;l++)if(null!==c[l]&&c[l].equals(this.startPoint()))for(u=a.divide(c[l]),d=0;d<u.length;d++)this.comparePathableTo(u[d])===e&&f.push(u[d]);f.sort(function(t,n){return i(p,e,t,n)}),(s=s.concat(f)).push(new h(this.center,this.radius,this.start,this.sweep,this.inverse))}return s}},o=Object.create(s);function r(t,e){this.slope=t,this.intercept=e}function a(t,e){this.start=t,this.angle=e}function c(t,e){this.p1=t,this.p2=e}function l(t,e){this.center=t,this.radius=e}function h(t,e,n,i,s){this.center=t,this.radius=e,this.start=n,this.sweep=i,this.inverse=void 0!==s&&s}function u(t,e){this.path=t,this.color=e}function d(){this.width=1500,this.height=500,this.cX=0,this.cY=0,this.conversionRatio=250,this.angle=0,this.zoomAmt=1.2}function p(){this.enclosures=[],this.segments=[],this.rays=[],this.lines=[],this.arcs=[],this.circles=[],this.points=[],this.next=null,this.previous=null}o.getSlope=function(){console.log("getSlope() hasn't been implemented"),console.trace()},o.getIntercept=function(){console.log("getIntercept() hasn't been implemented"),console.trace()},o.contains=function(){console.log("contains() hasn't been implemented"),console.trace()},o.distance=function(t){var e=this.getSlope(),n=this.getIntercept(),i=t.x,s=t.y;return Number.isFinite(e)?Math.abs(s-e*i-n)/Math.hypot(e,1):Math.abs(i-n)},o.curvature=function(){return 0},o.intersectLine=function(e){var i,s,o=this.getSlope(),r=this.getIntercept(),a=e.getSlope(),c=e.getIntercept();if(t.floatsEqual(o,a))return[];s=Number.isFinite(o)?Number.isFinite(a)?o*(i=(c-r)/(o-a))+r:o*(i=c)+r:a*(i=r)+c;var l=new n(i,s);return this.contains(l)&&e.contains(l)?[l]:[]},o.intersectCircle=function(e){var i=e.center.x,s=e.center.y,o=e.radius,r=this.getSlope(),a=this.getIntercept(),c=[],l=[];if(t.floatsEqual(this.distance(e.center),o)){var h=this.closestPoint(e.center);return e.contains(h)?[h]:[]}if(Number.isFinite(r)){var u=1+Math.pow(r,2),d=2*(r*a-i-r*s),p=Math.pow(i,2)+Math.pow(a,2)-2*a*s+Math.pow(s,2)-Math.pow(o,2),f=Math.pow(d,2)-4*u*p;if(f<0)return[];var g=(-d+Math.sqrt(f))/(2*u);c.push(new n(g,r*g+a)),g=(-d-Math.sqrt(f))/(2*u),c.push(new n(g,r*g+a))}else{if(a<i-o||a>i+o)return[];c.push(new n(a,s+Math.sqrt(Math.pow(o,2)-Math.pow(a-i,2)))),c.push(new n(a,s-Math.sqrt(Math.pow(o,2)-Math.pow(a-i,2))))}var v,w=c.length;for(v=0;v<w;v++)this.contains(c[v])&&e.contains(c[v])&&l.push(c[v]);return l},o.parallel=function(e){return t.floatsEqual(this.getSlope(),e.getSlope())},o.same=function(e){return t.floatsEqual(this.getSlope(),e.getSlope())&&t.floatsEqual(this.getIntercept(),e.getIntercept())},r.fromObject=function(t){return new r(t.slope,t.intercept)},r.fromTwoPoints=function(e,n){var i;return new r(i=t.floatsEqual(e.x,n.x)?Number.POSITIVE_INFINITY:(n.y-e.y)/(n.x-e.x),Number.isFinite(i)?e.y-i*e.x:e.x)},r.fromPointSlope=function(t,e){return new r(e,Number.isFinite(e)?t.y-e*t.x:t.x)},r.prototype=Object.create(o),r.prototype.isA=function(t){return"Line"===t||"AbstractLine"===t},r.prototype.getSlope=function(){return this.slope},r.prototype.getIntercept=function(){return this.intercept},r.prototype.closestPoint=function(e){var n=0;t.floatsEqual(this.getSlope(),0)?n=Number.POSITIVE_INFINITY:Number.isFinite(this.getSlope())&&(n=-1/this.getSlope());var i=r.fromPointSlope(e,n);return this.intersectLine(i)[0]},r.prototype.canSwitchSides=function(){return!1},r.prototype.divide=function(e){this.contains(e)||(e=this.closestPoint(e));var n=t.slopeToAngle(this.slope);return[new a(e,n),new a(e,t.oppositeAngle(n))]},r.prototype.contains=function(e){return Number.isFinite(this.slope)?t.floatsEqual(e.y,this.slope*e.x+this.intercept):t.floatsEqual(this.intercept,e.x)},r.prototype.getPortionInsideRectangle=function(e){for(var n=[],i=e.length,s=0;s<i;s++)for(var o=this.intersectLine(e[s]),r=o.length,a=0;a<r;a++)t.arrayContains(n,o[a])||n.push(o[a]);return n.length>=2?new c(n[0],n[1]):null},r.prototype.draw=function(t,e){var n=e.getAbstractBoundaries(),i=this.getPortionInsideRectangle(n);null!=i&&i.draw(t,e)},r.prototype.equals=function(e){return this===e||null!=e&&(!!e.isA("Line")&&(t.floatsEqual(this.intercept,other.intercept)&&t.floatsEqual(this.slope,other.slope)))},a.fromObject=function(t){return new a(n.fromObject(t.start),t.angle)},a.fromTwoPoints=function(t,e){var n=t.angle(e);return new a(t,n)},a.prototype=Object.create(o),a.prototype.isA=function(t){return"Ray"===t||"AbstractLine"===t},a.prototype.getSlope=function(){return t.floatsEqual(this.angle,Math.PI/2)?Number.POSITIVE_INFINITY:t.floatsEqual(this.angle,3*Math.PI/2)?Number.NEGATIVE_INFINITY:Math.tan(this.angle)},a.prototype.getIntercept=function(){var t=this.getSlope();return Number.isFinite(t)?this.start.y-t*this.start.x:this.start.x},a.prototype.closestPoint=function(e){var n=0;t.floatsEqual(this.getSlope(),0)?n=Number.POSITIVE_INFINITY:Number.isFinite(this.getSlope())&&(n=-1/this.getSlope());var i=r.fromPointSlope(e,n),s=this.intersectLine(i);return s.length>0?s[0]:this.start},a.prototype.startPoint=function(){return this.start},a.prototype.angleAtStart=function(){return this.angle},a.prototype.angleAtPoint=function(t){return this.angle},a.prototype.canSwitchSides=function(){return!1},a.prototype.distance=function(t){return this.closestPoint(t).dist(t)},a.prototype.distanceAlong=function(t){var e=t.startPoint();return this.start.dist(e)},a.prototype.divide=function(t){return this.contains(t)||(t=this.closestPoint(t)),this.start.equals(t)?[new a(t,this.angle)]:[new c(t,this.start),new a(t,this.angle)]},a.prototype.shortened=function(t){return new c(this.startPoint(),t.startPoint())},a.prototype.contains=function(e){var n=this.start.angle(e);return t.floatsEqual(n,this.angle)||e.equals(this.start)},a.prototype.getPortionInsideRectangle=function(e){for(var n=[this.start],i=e.length,s=0;s<i;s++)for(var o=this.intersectLine(e[s]),r=o.length,a=0;a<r;a++)t.arrayContains(n,o[a])||n.push(o[a]);return 2===n.length?new c(n[0],n[1]):n.length>2?new c(n[1],n[2]):null},a.prototype.sameDirection=function(t){return this.equals(t)},a.prototype.draw=function(t,e){var n=e.getAbstractBoundaries(),i=this.getPortionInsideRectangle(n);null!=i&&i.draw(t,e)},a.prototype.equals=function(e){return this===e||null!=e&&(!!e.isA("Ray")&&(this.start.equals(e.start)&&t.floatsEqual(this.angle,e.angle)))},c.fromObject=function(t){return new c(n.fromObject(t.p1),n.fromObject(t.p2))},c.prototype=Object.create(o),c.prototype.isA=function(t){return"Segment"===t||"AbstractLine"===t},c.prototype.getSlope=function(){return t.floatsEqual(this.p1.x,this.p2.x)?1/0:(this.p2.y-this.p1.y)/(this.p2.x-this.p1.x)},c.prototype.getIntercept=function(){var t=this.getSlope();return Number.isFinite(t)?this.p1.y-t*this.p1.x:this.p1.x},c.prototype.closestPoint=function(e){var n=0;t.floatsEqual(this.getSlope(),0)?n=Number.POSITIVE_INFINITY:Number.isFinite(this.getSlope())&&(n=-1/this.getSlope());var i=r.fromPointSlope(e,n),s=this.intersectLine(i);return s.length>0?s[0]:e.dist(this.p1)>e.dist(this.p2)?this.p2:this.p1},c.prototype.contains=function(e){var n=this.p1.x,i=this.p1.y,s=e.x,o=e.y,r=this.p2.x,a=this.p2.y,c=this.getSlope(),l=!Number.isFinite(c)&&t.floatsEqual(s,n)||t.floatsEqual(o-i,c*(s-n));return l=l&&t.isBetween(s,n,r)&&t.isBetween(o,i,a)},c.prototype.startPoint=function(){return this.p1},c.prototype.angleAtStart=function(){return this.p1.angle(this.p2)},c.prototype.angleAtPoint=function(t){return this.angleAtStart()},c.prototype.canSwitchSides=function(){return!0},c.prototype.distance=function(t){return this.closestPoint(t).dist(t)},c.prototype.distanceAlong=function(t){var e=t.startPoint();return this.p1.dist(e)},c.prototype.divide=function(t){return this.contains(t)||(t=this.closestPoint(t)),this.p1.equals(t)?[new c(t,this.p2)]:this.p2.equals(t)?[new c(t,this.p1)]:[new c(t,this.p1),new c(t,this.p2)]},c.prototype.shortened=function(t){return new c(this.startPoint(),t.startPoint())},c.prototype.sameDirection=function(t){return!!t.isA("Segment")&&(this.p1.equals(t.p1)&&this.p2.equals(t.p2))},c.prototype.isIn=function(t){return t.contains(this.p1)&&t.contains(this.p2)},c.prototype.draw=function(t,e){var n=e.abstractToScreenCoord(this.p1),i=e.abstractToScreenCoord(this.p2);t.beginPath(),t.moveTo(n.x,n.y),t.lineTo(i.x,i.y),t.stroke()},c.prototype.equals=function(t){return this===t||null!=t&&(!!t.isA("Segment")&&(this.p1.equals(t.p1)&&this.p2.equals(t.p2)||this.p1.equals(t.p2)&&this.p2.equals(t.p1)))},l.fromObject=function(t){return new l(n.fromObject(t.center),t.radius)},l.prototype=Object.create(s),l.prototype.isA=function(t){return"Circle"===t},l.prototype.contains=function(e){return t.floatsEqual(e.dist(this.center),this.radius)},l.prototype.getPointAtAngle=function(t){return new n(this.center.x+this.radius*Math.cos(t),this.center.y+this.radius*Math.sin(t))},l.prototype.intersectLine=function(t){return t.intersectCircle(this)},l.prototype.intersectCircle=function(e){var n,i=this.radius,s=e.radius,o=this.center.dist(e.center),r=this.center.angle(e.center);if(this.center.equals(e.center))return[];if(t.floatsEqual(o,i+s))return n=this.center.translate(i*Math.cos(r),i*Math.sin(r)),this.contains(n)&&e.contains(n)?[n]:[];if(t.floatsEqual(o,Math.abs(i-s)))return n=this.center.translate(i*Math.cos(r),i*Math.sin(r)),i<s&&(n=this.center.translate(i*Math.cos(t.oppositeAngle(r)),i*Math.sin(t.oppositeAngle(r)))),this.contains(n)&&e.contains(n)?[n]:[];if(o>i+s||o<Math.abs(i-s))return[];var a=[],c=Math.acos((Math.pow(i,2)+Math.pow(o,2)-Math.pow(s,2))/(2*i*o));return n=this.center.translate(i*Math.cos(r+c),i*Math.sin(r+c)),this.contains(n)&&e.contains(n)&&a.push(n),n=this.center.translate(i*Math.cos(r-c),i*Math.sin(r-c)),this.contains(n)&&e.contains(n)&&a.push(n),a},l.prototype.canSwitchSides=function(){return!1},l.prototype.distance=function(t){return Math.abs(this.center.dist(t)-this.radius)},l.prototype.curvature=function(){return 1/this.radius},l.prototype.closestPoint=function(t){var e=this.center.angle(t);return this.getPointAtAngle(e)},l.prototype.divide=function(t){this.contains(t)||(t=this.closestPoint(t));var e=this.center.angle(t),n=[];return n.push(new h(this.center,this.radius,e,2*Math.PI,!1)),n.push(new h(this.center,this.radius,e,2*Math.PI,!0)),n},l.prototype.draw=function(t,e){var n=e.abstractToScreenCoord(this.center),i=e.abstractToScreenDist(this.radius);t.beginPath(),t.arc(n.x,n.y,i,0,2*Math.PI),t.stroke()},l.prototype.same=function(e){return this.center.equals(e.center)&&t.floatsEqual(this.radius,e.radius)},l.prototype.equals=function(t){return this===t||null!=t&&(!(!t.isA("Circle")||t.isA("Arc"))&&this.same(t))},h.fromObject=function(t){return new h(n.fromObject(t.center),t.radius,t.start,t.sweep,t.inverse)},h.fromThreePoints=function(e,n,i){var s=e,o=e.dist(n),r=e.angle(n);return new h(s,o,r,t.angleDifference(e.angle(i),r))},h.prototype=Object.create(l.prototype),h.prototype.isA=function(t){return"Arc"===t||"Circle"===t},h.prototype.getEnd=function(){return t.angleSum(this.start,this.sweep)},h.prototype.contains=function(e){var n=this.center.dist(e);if(!t.floatsEqual(n,this.radius))return!1;var i=this.center.angle(e);return t.angleDifference(i,this.start)<this.sweep||t.floatsEqual(i,this.start)||t.floatsEqual(i,this.getEnd())},h.prototype.angleAtPoint=function(e){return this.inverse?t.angleDifference(this.center.angle(e),Math.PI/2):t.angleSum(this.center.angle(e),Math.PI/2)},h.prototype.startPoint=function(){return this.inverse?this.getPointAtAngle(this.getEnd()):this.getPointAtAngle(this.start)},h.prototype.angleAtStart=function(){return this.angleAtPoint(this.startPoint())},h.prototype.curvature=function(){var t=1/this.radius;return this.inverse&&(t*=-1),t},h.prototype.canSwitchSides=function(){return!t.floatsEqual(this.sweep,2*Math.PI)},h.prototype.distance=function(t){return this.closestPoint(t).dist(t)},h.prototype.closestPoint=function(t){var e=this.center.angle(t),n=this.getPointAtAngle(e);if(this.contains(n))return n;var i=this.getPointAtAngle(this.start),s=this.getPointAtAngle(this.getEnd());return t.dist(i)<t.dist(s)?i:s},h.prototype.distanceAlong=function(e){var n=e.startPoint(),i=this.center.angle(n),s=t.angleDifference(i,this.start);return this.inverse&&(s=t.angleDifference(this.getEnd(),i)),s},h.prototype.divide=function(e){this.contains(e)||(e=this.closestPoint(e));var n=this.center.angle(e);if(t.floatsEqual(n,this.start))return[new h(this.center,this.radius,this.start,this.sweep,!1)];if(t.floatsEqual(n,this.getEnd()))return[new h(this.center,this.radius,this.start,this.sweep,!0)];var i=[];return i.push(new h(this.center,this.radius,n,t.angleDifference(this.getEnd(),n),!1)),i.push(new h(this.center,this.radius,this.start,t.angleDifference(n,this.start),!0)),i},h.prototype.shortened=function(e){var n=this.start,i=this.center.angle(e.startPoint());this.inverse&&(n=this.center.angle(e.startPoint()),i=this.getEnd());var s=t.angleDifference(i,n);return t.floatsEqual(s,0)&&(s=2*Math.PI),new h(this.center,this.radius,n,s,this.inverse)},h.prototype.sameDirection=function(t){return!!t.isA("Arc")&&(this.equals(t)&&this.inverse===t.inverse)},h.prototype.isIn=function(e){var n=t.angleDifference(this.start,e.start)<=e.sweep,i=this.sweep<t.angleDifference(e.getEnd(),this.start);return n&&i},h.prototype.draw=function(e,n){var i=n.abstractToScreenCoord(this.center),s=n.abstractToScreenDist(this.radius),o=t.angleSum(this.start,n.angle),r=t.angleSum(this.getEnd(),n.angle);e.beginPath(),e.arc(i.x,i.y,s,o,r),e.stroke()},h.prototype.equals=function(e){return this===e||null!=e&&(!!e.isA("Arc")&&(this.center.equals(e.center)&&t.floatsEqual(this.radius,e.radius)&&t.floatsEqual(this.start,e.start)&&t.floatsEqual(this.sweep,e.sweep)))},u.fromObject=function(t){for(var e=[],n=t.path.length,i=0;i<n;i++){var s=t.path[i];void 0!==s.p1?e.push(c.fromObject(s)):void 0!==s.sweep?e.push(h.fromObject(s)):console.log("This should never happen (Enclosure.fromObject)")}return new u(e,t.color)},u.findEnclosure=function(e,n){var i,s,o,r,a=null,c=n.getPathables();for(c.sort(function(n,i){var s=n.distance(e),o=i.distance(e);if(t.floatsEqual(s,o)){if(n.isA("Circle")&&i.isA("Circle")){var r=n.center.dist(e),a=i.center.dist(e);return t.floatsEqual(r,a)?0:r<a?-1:1}return 0}return s<o?-1:1}),o=c.length,i=0;i<o;i++){var l=c[i],h=l.divide(l.closestPoint(e));for(r=h.length,s=0;s<r;s++){var d=h[s].comparePointTo(e);if(null!==(a=u.findEnclosureRecurse(e,[],h[s],d,n))&&a.contains(e))return a}}return null},u.findEnclosureRecurse=function(e,n,i,s,o){var r,a,c=null,l=i.getIntersectionsInOrder(s,o);for(a=l.length,r=0;r<a;r++){c=n.slice(0);var h=l[r],d=i.shortened(h),p=t.arrayIndexOf(c,d);if(p!==t.arrayLastIndexOf(c,d)||t.arrayContains(c,d)&&d.sameDirection(c[p]))return new u(c=c.slice(p));c.push(d);var f=u.findEnclosureRecurse(e,c,h,s,o);if(null!==f)return f}return null},u.prototype.contains=function(t){for(var e=new a(t,0),n=new a(t,Math.PI),i=0,s=0,o=0;o<this.path.length;o++){var r=this.path[o],c=e.intersect(r);i+=c.length,s+=(c=n.intersect(r)).length}return i%2==s%2&&i%2!=0},u.prototype.draw=function(e,n){e.fillStyle=this.color,e.beginPath();var i=n.abstractToScreenCoord(this.path[0].startPoint());e.moveTo(i.x,i.y);for(var s=0;s<this.path.length;s++){var o=this.path[s];if(o.isA("Segment"))i=n.abstractToScreenCoord(o.p2),e.lineTo(i.x,i.y);else if(o.isA("Arc")){i=n.abstractToScreenCoord(o.center);var r=n.abstractToScreenDist(o.radius),a=t.angleSum(o.start,n.angle),c=t.angleSum(o.getEnd(),n.angle);t.floatsEqual(o.sweep,2*Math.PI)&&(c=o.start+2*Math.PI),o.inverse?e.arc(i.x,i.y,r,c,a,!0):e.arc(i.x,i.y,r,a,c,!1)}else console.log("Enclosure.draw invalid enclosure"),console.log(this.path),console.log(o)}e.closePath(),e.fill()},d.prototype.setValues=function(t){void 0!==t.cX&&(this.cX=t.cX),void 0!==t.cY&&(this.cY=t.cY),void 0!==t.conversionRatio&&(this.conversionRatio=t.conversionRatio),void 0!==t.angle&&(this.angle=t.angle)},d.prototype.getAbstractBoundaries=function(){var t=this.screenToAbstractCoord(new n(0,0)),e=this.screenToAbstractCoord(new n(this.width,0)),i=this.screenToAbstractCoord(new n(this.width,this.height)),s=this.screenToAbstractCoord(new n(0,this.height)),o=[];return o.push(new c(t,e)),o.push(new c(e,i)),o.push(new c(i,s)),o.push(new c(s,t)),o},d.prototype.zoomIn=function(t,e){this.conversionRatio=this.conversionRatio*this.zoomAmt;var i=this.screenToAbstractCoord(new n(t,e)),s=new n(this.cX,this.cY).angle(i),o=new n(this.cX,this.cY).dist(i);this.cX+=(this.zoomAmt-1)*o*Math.cos(s),this.cY+=(this.zoomAmt-1)*o*Math.sin(s)},d.prototype.zoomOut=function(t,e){var i=this.screenToAbstractCoord(new n(t,e)),s=new n(this.cX,this.cY).angle(i),o=new n(this.cX,this.cY).dist(i);this.cX-=(this.zoomAmt-1)*o*Math.cos(s),this.cY-=(this.zoomAmt-1)*o*Math.sin(s),this.conversionRatio=this.conversionRatio/this.zoomAmt},d.prototype.translate=function(t,e){var n=this.screenToAbstractCoord(e),i=n.x-t.x,s=n.y-t.y;this.cX=this.cX-i,this.cY=this.cY-s},d.prototype.zoom=function(e,n,i,s,o){var r=e.dist(n),a=i.dist(s);if(!o){var c=e.angle(n),l=i.angle(s);this.angle=t.angleDifference(l,c)}this.conversionRatio=a/r,this.translate(e,i)},d.prototype.autoZoom=function(t){var e,i,s,o,r,a,c,l,h,u,d;function p(t){t.x<e&&(e=t.x),t.x>i&&(i=t.x),t.y<s&&(s=t.y),t.y>o&&(o=t.y)}for(c=t.points[0].rotateAroundOrigin(this.angle),e=i=c.x,s=o=c.y,a=t.points.length,r=1;r<a;r++)p(c=t.points[r].rotateAroundOrigin(this.angle));for(a=t.arcs.length,r=0;r<a;r++)l=(c=(h=(u=t.arcs[r]).center.rotateAroundOrigin(this.angle)).translate(-u.radius,0)).rotateAroundOrigin(-this.angle),u.contains(l)&&p(c),l=(c=h.translate(u.radius,0)).rotateAroundOrigin(-this.angle),u.contains(l)&&p(c),l=(c=h.translate(0,-u.radius)).rotateAroundOrigin(-this.angle),u.contains(l)&&p(c),l=(c=h.translate(0,u.radius)).rotateAroundOrigin(-this.angle),u.contains(l)&&p(c);for(a=t.circles.length,r=0;r<a;r++)p(c=(h=(d=t.circles[r]).center.rotateAroundOrigin(this.angle)).translate(-d.radius,0)),p(c=h.translate(d.radius,0)),p(c=h.translate(0,-d.radius)),p(c=h.translate(0,d.radius));this.conversionRatio=Math.min((this.width-2)/(i-e),(this.height-2)/(o-s)),c=(c=new n((i+e)/2,(o+s)/2)).rotateAroundOrigin(-this.angle),this.cX=c.x,this.cY=c.y},d.prototype.abstractToScreenDist=function(t){return t*this.conversionRatio},d.prototype.screenToAbstractDist=function(t){return t/this.conversionRatio},d.prototype.abstractToScreenCoord=function(t){var e=new n((t.x-this.cX)*this.conversionRatio,(t.y-this.cY)*this.conversionRatio);return(e=e.rotateAroundOrigin(this.angle)).x=e.x+this.width/2,e.y=e.y+this.height/2,e},d.prototype.screenToAbstractCoord=function(t){var e=new n(t.x-this.width/2,t.y-this.height/2);return(e=e.rotateAroundOrigin(-this.angle)).x=e.x/this.conversionRatio+this.cX,e.y=e.y/this.conversionRatio+this.cY,e},d.prototype.copy=function(){var t=new d;return t.cX=this.cX,t.cY=this.cY,t.conversionRatio=this.conversionRatio,t.anlge=this.angle,t.height=this.height,t.width=this.width,t},d.prototype.toJSON=function(){return{cX:this.cX,cY:this.cY,conversionRatio:this.conversionRatio,angle:this.angle,height:this.height,width:this.width}},p.fromObject=function(t){var e,i,s=new p;for(i=t.enclosures.length,e=0;e<i;e++)s.enclosures.push(u.fromObject(t.enclosures[e]));for(i=t.segments.length,e=0;e<i;e++)s.segments.push(c.fromObject(t.segments[e]));for(i=t.rays.length,e=0;e<i;e++)s.rays.push(a.fromObject(t.rays[e]));for(i=t.lines.length,e=0;e<i;e++)s.lines.push(r.fromObject(t.lines[e]));for(i=t.arcs.length,e=0;e<i;e++)s.arcs.push(h.fromObject(t.arcs[e]));for(i=t.circles.length,e=0;e<i;e++)s.circles.push(l.fromObject(t.circles[e]));for(i=t.points.length,e=0;e<i;e++)s.points.push(n.fromObject(t.points[e]));return s},p.prototype.start=function(){var t;for(this.circles.push(new l(new n(0,0),1)),this.points.push(new n(0,0)),t=0;t<6;t++)this.points.push(new n(1*Math.cos(t*Math.PI/3),1*Math.sin(t*Math.PI/3)))},p.prototype.getTopEnclosure=function(t){for(var e=this.enclosures.length-1;e>=0;e--)if(this.enclosures[e].contains(t))return this.enclosures[e];return null},p.prototype.getPathables=function(){var t=this.segments.concat(this.rays);return t=(t=(t=t.concat(this.lines)).concat(this.arcs)).concat(this.circles)},p.prototype.nearestPoint=function(t){for(var e=this.points[0],n=t.dist(e),i=this.points.length,s=1;s<i;s++){var o=this.points[s];t.dist(o)<n&&(e=o,n=t.dist(e))}return e},p.prototype.addEnclosure=function(t){this.enclosures.push(t)},p.prototype.addAllIntersections=function(t){var e,n;for(n=this.segments.length,e=0;e<n;e++)this.addPoints(t.intersectLine(this.segments[e]));for(n=this.rays.length,e=0;e<n;e++)this.addPoints(t.intersectLine(this.rays[e]));for(n=this.lines.length,e=0;e<n;e++)this.addPoints(t.intersectLine(this.lines[e]));for(n=this.arcs.length,e=0;e<n;e++)this.addPoints(t.intersectCircle(this.arcs[e]));for(n=this.circles.length,e=0;e<n;e++)this.addPoints(t.intersectCircle(this.circles[e]))},p.prototype.addSegmentWithIntersections=function(t){this.addAllIntersections(t),this.addSegmentWithoutIntersections(t)},p.prototype.addSegmentWithoutIntersections=function(t){var e,n;for(n=this.lines.length,e=0;e<n;e++)if(t.same(this.lines[e]))return;for(n=this.rays.length,e=0;e<n;e++){var i=this.rays[e];if(t.same(i)){if(i.contains(t.p1)&&i.contains(t.p2))return;if(i.contains(t.p1))return this.rays.splice(e,1),void this.addRayWithoutIntersections(new a(t.p2,i.angle));if(i.contains(t.p2))return this.rays.splice(e,1),void this.addRayWithoutIntersections(new a(t.p1,i.angle))}}for(n=this.segments.length,e=0;e<n;e++){var s=this.segments[e];if(t.same(s)){if(t.isIn(s))return;s.isIn(t)?(this.segments.splice(e,1),e--,n--):t.contains(s.p1)&&s.contains(t.p1)?(t=new c(t.p2,s.p2),this.segments.splice(e,1),e--,n--):t.contains(s.p1)&&s.contains(t.p2)?(t=new c(t.p1,s.p2),this.segments.splice(e,1),e--,n--):t.contains(s.p2)&&s.contains(t.p1)?(t=new c(t.p2,s.p1),this.segments.splice(e,1),e--,n--):t.contains(s.p2)&&s.contains(t.p2)&&(t=new c(t.p1,s.p1),this.segments.splice(e,1),e--,n--)}}this.segments.push(t)},p.prototype.addRayWithIntersections=function(t){this.addAllIntersections(t),this.addRayWithoutIntersections(t)},p.prototype.addRayWithoutIntersections=function(e){var n,i;for(i=this.lines.length,n=0;n<i;n++)if(e.same(this.lines[n]))return;for(i=this.rays.length,n=0;n<i;n++){var s=this.rays[n];if(e.same(s))if(t.floatsEqual(e.angle,s.angle)){if(!e.contains(s.start))return;this.rays.splice(n,1),n--,i--}else if(e.contains(s.start))return this.rays.splice(n,1),void this.addLineWithoutIntersections(new r(e.getSlope(),e.getIntercept()))}for(i=this.segments.length,n=0;n<i;n++){var o=this.segments[n];e.same(o)&&(e.contains(o.p1)&&e.contains(o.p2)?(this.segments.splice(n,1),n--,i--):e.contains(o.p1)?(e=new a(o.p2,e.angle),this.segments.splice(n,1),n--,i--):e.contains(o.p2)&&(e=new a(o.p1,e.angle),this.segments.splice(n,1),n--,i--))}this.rays.push(e)},p.prototype.addLineWithIntersections=function(t){this.addAllIntersections(t),this.addLineWithoutIntersections(t)},p.prototype.addLineWithoutIntersections=function(t){var e,n;for(n=this.lines.length,e=0;e<n;e++)if(t.same(this.lines[e]))return;function i(e){return!t.same(e)}this.segments=this.segments.filter(i),this.rays=this.rays.filter(i),this.lines.push(t)},p.prototype.addArcWithIntersections=function(t){this.addAllIntersections(t),this.addArcWithoutIntersections(t)},p.prototype.addArcWithoutIntersections=function(e){var n,i;for(i=this.circles.length,n=0;n<i;n++)if(e.same(this.circles[n]))return;for(i=this.arcs.length,n=0;n<i;n++){var s=this.arcs[n];if(e.same(s)){if(e.isIn(s))return;if(s.isIn(e))this.arcs.splice(n,1),n--,i--;else{if(t.floatsEqual(e.start,s.getEnd())&&t.floatsEqual(e.getEnd(),s.start))return this.arcs.splice(n,1),void this.addCircleWithoutIntersections(new l(e.center,e.radius));if(t.floatsEqual(e.start,s.getEnd())&&t.angleDifference(e.getEnd(),s.start)<s.sweep)return this.arcs.splice(n,1),void this.addCircleWithoutIntersections(new l(e.center,e.radius));if(t.angleDifference(e.start,s.start)<s.sweep&&t.angleDifference(e.getEnd(),s.start)<s.sweep)return this.arcs.splice(n,1),void this.addCircleWithoutIntersections(new l(e.center,e.radius));t.angleDifference(e.start,s.start)<s.sweep?(this.arcs.splice(n,1),n--,i--,e=new h(e.center,e.radius,s.start,t.angleDifference(e.getEnd(),s.start))):t.angleDifference(e.getEnd(),s.start)<s.sweep&&(this.arcs.splice(n,1),n--,i--,e=new h(e.center,e.radius,e.start,t.angleDifference(s.getEnd(),e.start)))}}}this.arcs.push(e)},p.prototype.addCircleWithIntersections=function(t){this.addAllIntersections(t),this.addCircleWithoutIntersections(t)},p.prototype.addCircleWithoutIntersections=function(t){var e,n;for(n=this.circles.length,e=0;e<n;e++)if(t.same(this.circles[e]))return;this.arcs=this.arcs.filter(function(e){return!t.same(e)}),this.circles.push(t)},p.prototype.addPoint=function(t){this.points.push(t)},p.prototype.addPoints=function(e){for(var n=e.length,i=0;i<n;i++)t.arrayContains(this.points,e[i])||this.points.push(e[i])},p.prototype.removeEnclosure=function(t){var e,n;for(n=this.enclosures.length,e=0;e<n;e++)this.enclosures[e].contains(t)&&(this.enclosures.splice(e,1),e--,n--)},p.prototype.removeSegment=function(e){var n,i;for(i=this.segments.length,n=0;n<i;n++){var s=this.segments[n];if(e.same(s))if(e.equals(s)||s.isIn(e))this.segments.splice(n,1),n--,i--;else if(e.isIn(s)){var o=s.p1,r=s.p2,l=e.p1,h=e.p2;t.floatsEqual(o.x,r.x)?(r.y<o.y&&(o=s.p2,r=s.p1),h.y<l.y&&(l=e.p2,h=e.p1)):(r.x<o.x&&(o=s.p2,r=s.p1),h.x<l.x&&(l=e.p2,h=e.p1)),this.segments.splice(n,1),this.addSegmentWithoutIntersections(new c(o,l)),this.addSegmentWithoutIntersections(new c(h,r)),n--,i--}else e.contains(s.p1)?(this.segments.splice(n,1),s.contains(e.p1)?this.addSegmentWithoutIntersections(new c(e.p1,s.p2)):this.addSegmentWithoutIntersections(new c(e.p2,s.p2)),n--,i--):e.contains(s.p2)&&(this.segments.splice(n,1),s.contains(e.p1)?this.addSegmentWithoutIntersections(new c(e.p1,s.p1)):this.addSegmentWithoutIntersections(new c(e.p2,s.p1)),n--,i--)}for(i=this.rays.length,n=0;n<i;n++){var u=this.rays[n];if(e.same(u))if(u.contains(e.p1)&&u.contains(e.p2)){var d=new c(u.start,e.p1),p=e.p2;d.contains(e.p2)&&(d=new c(u.start,e.p2),p=e.p1),this.rays.splice(n,1),this.addRayWithoutIntersections(new a(p,u.angle)),d.p1.equals(d.p2)||this.addSegmentWithoutIntersections(d),n--,i--}else u.contains(e.p1)&&!u.start.equals(e.p1)?(this.rays.splice(n,1),this.addRayWithoutIntersections(new a(e.p1,u.angle)),n--,i--):u.contains(e.p2)&&!u.start.equals(e.p2)&&(this.rays.splice(n,1),this.addRayWithoutIntersections(new a(e.p2,u.angle)),n--,i--)}for(i=this.lines.length,n=0;n<i;n++){var f=this.lines[n];if(e.same(f)){var g=t.slopeToAngle(f.slope),v=t.oppositeAngle(g),w=new a(e.p1,g),m=new a(e.p2,v);(w.contains(e.p2)||m.contains(e.p1))&&(w=new a(e.p1,v),m=new a(e.p2,g)),this.lines.splice(n,1),this.addRayWithoutIntersections(w),this.addRayWithoutIntersections(m),n--,i--}}},p.prototype.removeRay=function(e){var n,i;for(i=this.segments.length,n=0;n<i;n++){var s=this.segments[n];e.same(s)&&(e.contains(s.p1)&&e.contains(s.p2)?(this.segments.splice(n,1),n--,i--):e.contains(s.p1)?(this.segments.splice(n,1),this.addSegmentWithoutIntersections(new c(s.p2,e.start)),n--,i--):e.contains(s.p2)&&(this.segments.splice(n,1),this.addSegmentWithoutIntersections(new c(s.p1,e.start)),n--,i--))}for(i=this.rays.length,n=0;n<i;n++){var o=this.rays[n];e.same(o)&&(t.floatsEqual(e.angle,o.angle)?e.contains(o.start)?(this.rays.splice(n,1),n--,i--):(this.rays.splice(n,1),this.addSegmentWithoutIntersections(new c(e.start,o.start)),n--,i--):e.contains(o.start)&&!e.start.equals(o.start)&&(this.rays.splice(n,1),this.addRayWithoutIntersections(new a(e.start,o.angle)),n--,i--))}for(i=this.lines.length,n=0;n<i;n++){var r=this.lines[n];e.same(r)&&(this.lines.splice(n,1),this.addRayWithoutIntersections(new a(e.start,t.oppositeAngle(e.angle))),n--,i--)}},p.prototype.removeLine=function(t){var e,n;for(n=this.segments.length,e=0;e<n;e++){var i=this.segments[e];t.same(i)&&(this.segments.splice(e,1),e--,n--)}for(n=this.rays.length,e=0;e<n;e++){var s=this.rays[e];t.same(s)&&(this.rays.splice(e,1),e--,n--)}for(n=this.lines.length,e=0;e<n;e++){var o=this.lines[e];t.same(o)&&(this.lines.splice(e,1),e--,n--)}},p.prototype.removeArc=function(e){var n,i;for(i=this.arcs.length,n=0;n<i;n++){var s=this.arcs[n];e.same(s)&&(e.equals(s)||s.isIn(e)?(this.arcs.splice(n,1),n--,i--):e.isIn(s)?(this.arcs.splice(n,1),t.floatsEqual(e.start,s.start)||this.addArcWithoutIntersections(new h(e.center,e.radius,s.start,t.angleDifference(e.start,s.start))),t.floatsEqual(s.getEnd(),e.getEnd())||this.addArcWithoutIntersections(new h(e.center,e.radius,e.getEnd(),t.angleDifference(s.getEnd(),e.getEnd()))),n--,i--):t.angleDifference(e.start,s.start)<s.sweep&&t.angleDifference(e.getEnd(),s.start)<s.sweep?(this.arcs.splice(n,1),this.addArcWithoutIntersections(new h(e.center,e.radius,e.getEnd(),t.angleDifference(e.start,e.getEnd()))),n--,i--):t.angleDifference(e.start,s.start)<s.sweep?(this.arcs.splice(n,1),this.addArcWithoutIntersections(new h(e.center,e.radius,s.start,t.angleDifference(e.start,s.start))),n--,i--):t.angleDifference(e.getEnd(),s.start)<s.sweep&&(this.arcs.splice(n,1),this.addArcWithoutIntersections(new h(e.center,e.radius,e.getEnd(),t.angleDifference(s.getEnd(),e.getEnd()))),n--,i--))}for(i=this.circles.length,n=0;n<i;n++){var o=this.circles[n];e.same(o)&&(this.circles.splice(n,1),this.addArcWithoutIntersections(new h(e.center,e.radius,e.getEnd(),t.angleDifference(2*Math.PI,e.sweep))),n--,i--)}},p.prototype.removeCircle=function(t){var e,n;for(n=this.arcs.length,e=0;e<n;e++){var i=this.arcs[e];t.same(i)&&(this.arcs.splice(e,1),e--,n--)}for(n=this.circles.length,e=0;e<n;e++){var s=this.circles[e];t.same(s)&&(this.circles.splice(e,1),e--,n--)}},p.prototype.removePoint=function(t){var e,n;for(n=this.points.length,e=0;e<n;e++)t.equals(this.points[e])&&(this.points.splice(e,1),e--,n--)},p.prototype.copy=function(){var t=new p;return t.enclosures=this.enclosures.slice(0),t.segments=this.segments.slice(0),t.rays=this.rays.slice(0),t.lines=this.lines.slice(0),t.arcs=this.arcs.slice(0),t.circles=this.circles.slice(0),t.points=this.points.slice(0),t},p.prototype.draw=function(t,e,n,i){var s,o;for(o=this.enclosures.length,s=0;s<o;s++)this.enclosures[s].draw(t,e);if(n){for(o=this.segments.length,s=0;s<o;s++)this.segments[s].draw(t,e);for(o=this.rays.length,s=0;s<o;s++)this.rays[s].draw(t,e);for(o=this.lines.length,s=0;s<o;s++)this.lines[s].draw(t,e);for(o=this.arcs.length,s=0;s<o;s++)this.arcs[s].draw(t,e);for(o=this.circles.length,s=0;s<o;s++)this.circles[s].draw(t,e)}if(i)for(o=this.points.length,s=0;s<o;s++)this.points[s].draw(t,e)},p.prototype.toJSON=function(){return{enclosures:this.enclosures,segments:this.segments,rays:this.rays,lines:this.lines,arcs:this.arcs,circles:this.circles,points:this.points}};var f=[];function g(t,e){this.name=t,this.pointsNeeded=e}g.prototype.shadowHook1=function(t){return[]},g.prototype.shadowHook2=function(t,e){return this.shadowHook1(t)},g.prototype.shadowHook3=function(t,e,n){return this.shadowHook2(t,e)},g.prototype.press=function(t,e){var i;i=new n(t,e),function(t){for(var e=!0,n=J.length,i=0;i<n;i++)if(t.equals(J[i])){e=!1;break}e&&J.push(t),ot()}(X.nearestPoint(F.screenToAbstractCoord(i))),J.length===this.pointsNeeded&&(_=[],this.endHook(),J=[])},g.prototype.release=function(t,e){1===J.length&&this.press(t,e)},g.prototype.click=function(t,e){this.release(t,e)},g.prototype.drag=function(t,e){var i,s,o,r=(i=new n(t,e),s=F.screenToAbstractCoord(i),o=X.nearestPoint(s),F.abstractToScreenDist(s.dist(o))<20?o:s);0===J.length?_=this.shadowHook1(r):1===J.length?_=this.shadowHook2(J[0],r):2===J.length&&(_=this.shadowHook3(J[0],J[1],r)),ot()};var v=new g("Draw Segment",2);v.shadowHook2=function(t,e){return[new c(t,e)]},v.endHook=function(){it(function(t){t.addSegmentWithIntersections(new c(J[0],J[1]))})},f.push(v);var w=new g("Draw Ray",2);w.shadowHook2=function(t,e){return[a.fromTwoPoints(t,e)]},w.endHook=function(){it(function(t){t.addRayWithIntersections(a.fromTwoPoints(J[0],J[1]))})},f.push(w);var m=new g("Draw Line",2);m.shadowHook2=function(t,e){return[r.fromTwoPoints(t,e)]},m.endHook=function(){it(function(t){t.addLineWithIntersections(r.fromTwoPoints(J[0],J[1]))})},f.push(m);var y=new g("Draw Arc",3);y.shadowHook2=function(t,e){return[new l(t,t.dist(e))]},y.shadowHook3=function(t,e,n){return[h.fromThreePoints(t,e,n)]},y.endHook=function(){it(function(t){t.addArcWithIntersections(h.fromThreePoints(J[0],J[1],J[2]))})},f.push(y);var A=new g("Draw Circle",2);A.shadowHook2=function(t,e){return[new l(t,t.dist(e))]},A.endHook=function(){it(function(t){t.addCircleWithIntersections(new l(J[0],J[0].dist(J[1])))})},f.push(A);var I=new g("Erase Segment",2);I.shadowHook2=v.shadowHook2,I.endHook=function(){it(function(t){t.removeSegment(new c(J[0],J[1]))})},f.push(I);var P=new g("Erase Ray",2);P.shadowHook2=w.shadowHook2,P.endHook=function(){it(function(t){t.removeRay(a.fromTwoPoints(J[0],J[1]))})},f.push(P);var S=new g("Erase Line",2);S.shadowHook2=m.shadowHook2,S.endHook=function(){it(function(t){t.removeLine(r.fromTwoPoints(J[0],J[1]))})},f.push(S);var b=new g("Erase Arc",3);b.shadowHook2=y.shadowHook2,b.shadowHook3=y.shadowHook3,b.endHook=function(){it(function(t){t.removeArc(h.fromThreePoints(J[0],J[1],J[2]))})},f.push(b);var E=new g("Erase Circle",2);E.shadowHook2=A.shadowHook2,E.endHook=function(){it(function(t){t.removeCircle(new l(J[0],J[0].dist(J[1])))})},f.push(E);var M=new g("Erase Point",1);M.shadowHook1=function(t){return[t]},M.endHook=function(){it(function(t){t.removePoint(J[0])})},f.push(M);var T=new g("Midpoint",2);T.shadowHook2=function(e,n){return[t.midPoint(e,n)]},T.endHook=function(){it(function(e){e.addPoint(t.midPoint(J[0],J[1]))})},f.push(T);var x=new g("Trisect",2);x.calculatePoints=function(t,e){var i=e.x-t.x,s=e.y-t.y,o=t.x+i/3,r=t.y+s/3,a=t.x+2*i/3,c=t.y+2*s/3;return[new n(o,r),new n(a,c)]},x.shadowHook2=function(t,e){return this.calculatePoints(t,e)},x.endHook=function(){var t=this.calculatePoints(J[0],J[1]);it(function(e){e.addPoints(t)})},f.push(x);var D=new g("Perpendicular Bisector",2);D.calculateLine=function(e,n){var i=t.midPoint(e,n),s=r.fromTwoPoints(e,n).getSlope();return r.fromPointSlope(i,t.perpendicularSlope(s))},D.shadowHook2=function(e,n){return[this.calculateLine(e,n),t.midPoint(e,n)]},D.endHook=function(){var e=this.calculateLine(J[0],J[1]);it(function(n){n.addPoint(t.midPoint(J[0],J[1])),n.addLineWithIntersections(e)})},f.push(D);var C=new g("Angle Bisector",3);C.calculateLine=function(e,n,i){var s=(n.angle(e)+n.angle(i))/2,o=t.angleToSlope(s);return r.fromPointSlope(n,o)},C.shadowHook2=function(t,e){return[r.fromTwoPoints(t,e)]},C.shadowHook3=function(t,e,n){return[this.calculateLine(t,e,n)]},C.endHook=function(){var t=this.calculateLine(J[0],J[1],J[2]);it(function(e){e.addLineWithIntersections(t)})},f.push(C);var q=new g("Tangent Line",2);q.calculateLine=function(e,n){var i=r.fromTwoPoints(e,n).getSlope();return r.fromPointSlope(n,t.perpendicularSlope(i))},q.shadowHook2=function(t,e){return[this.calculateLine(t,e)]},q.endHook=function(){var t=this.calculateLine(J[0],J[1]);it(function(e){e.addLineWithIntersections(t)})},f.push(q);var k=new g("Parallel Line",3);k.calculateLine=function(t,e,n){var i=r.fromTwoPoints(t,e).getSlope();return r.fromPointSlope(n,i)},k.shadowHook2=function(t,e){return[r.fromTwoPoints(t,e)]},k.shadowHook3=function(t,e,n){return[this.calculateLine(t,e,n)]},k.endHook=function(){var t=this.calculateLine(J[0],J[1],J[2]);it(function(e){e.addLineWithIntersections(t)})},f.push(k);var H=new g("Circumscribe Triangle",3);H.calculateCenter=function(e,n,i){var s=r.fromTwoPoints(e,n);s=r.fromPointSlope(t.midPoint(e,n),t.perpendicularSlope(s.getSlope()));var o=r.fromTwoPoints(n,i);o=r.fromPointSlope(t.midPoint(n,i),t.perpendicularSlope(o.getSlope()));var a=s.intersectLine(o);return a.length>0?a[0]:null},H.shadowHook2=function(e,n){var i=t.midPoint(e,n),s=new l(i,i.dist(e));return[i,s]},H.shadowHook3=function(t,e,n){var i=this.calculateCenter(t,e,n);if(null===i)return[];var s=new l(i,i.dist(t));return[i,s]},H.calculateCircle=function(t,e,n){var i=this.calculateCenter(t,e,n);return null===i?null:new l(i,i.dist(t))},H.endHook=function(){var t=this.calculateCenter(J[0],J[1],J[2]);if(null!==t){var e=this.calculateCircle(J[0],J[1],J[2]);it(function(n){n.addPoint(t),n.addCircleWithIntersections(e)})}},f.push(H);var R=new g("Compass",3);R.shadowHook2=function(t,e){return[new l(t,t.dist(e))]},R.shadowHook3=function(t,e,n){return[new l(n,t.dist(e))]},R.endHook=function(){it(function(t){t.addCircleWithIntersections(new l(J[2],J[0].dist(J[1])))})},f.push(R);var W=new g("Fill Color",0);W.press=function(){},W.release=function(t,e){var i=F.screenToAbstractCoord(new n(t,e)),s=u.findEnclosure(i,X);null!==s&&(s.color=G,it(function(t){t.addEnclosure(s)}))},W.click=function(){},W.drag=function(){},f.push(W);var O=new g("Erase Color",0);O.press=function(){},O.release=function(t,e){var i=F.screenToAbstractCoord(new n(t,e));it(function(t){t.removeEnclosure(i)})},O.click=function(){},O.drag=function(){},f.push(O);var L=new g("Pick Color",0);L.press=function(){},L.release=function(t,e){var i=F.screenToAbstractCoord(new n(t,e)),s=X.getTopEnclosure(i);null!==s&&(G=s.color,$("#chooseColor").val(s.color))},L.click=function(){},L.drag=function(){},f.push(L);var N=new g("Pan",0);N.oldPoint=null,N.press=function(t,e){this.oldPoint=F.screenToAbstractCoord(new n(t,e))},N.release=function(t,e){this.oldPoint=null},N.click=function(){},N.drag=function(t,e){if(null!==this.oldPoint){var i=F.screenToAbstractCoord(new n(t,e)),s=i.x-this.oldPoint.x,o=i.y-this.oldPoint.y;F.cX=F.cX-s,F.cY=F.cY-o,ot()}},f.push(N);var Y=new g("Rotate",0);Y.oldAngle=null,Y.press=function(t,e){var i=new n(F.cX,F.cY);this.oldAngle=i.angle(F.screenToAbstractCoord(new n(t,e)))},Y.release=function(t,e){this.oldAngle=null},Y.click=function(){},Y.drag=function(e,i){if(null!==this.oldAngle){var s=new n(F.cX,F.cY).angle(F.screenToAbstractCoord(new n(e,i)))-this.oldAngle;F.angle=t.angleSum(F.angle,s),ot()}},f.push(Y);var j={multiTouchMode:!1,abstractPoints:[],touchStart:function(t){this.multiTouchMode||(J=[],_=[],this.multiTouchMode=!0),this.abstractPoints=[];for(var e=0;e<t.length;e++){var i=new n(t[e].x,t[e].y);this.abstractPoints.push(F.screenToAbstractCoord(i))}},touchMove:function(t){for(var e=[],i=0;i<t.length;i++){var s=new n(t[i].x,t[i].y);e.push(s)}this.abstractPoints.length>1&&e.length>1?F.zoom(this.abstractPoints[0],this.abstractPoints[1],e[0],e[1],!1):F.translate(this.abstractPoints[0],e[0]),ot()},touchEnd:function(t){this.abstractPoints=[];for(var e=0;e<t.length;e++){var i=new n(t[e].x,t[e].y);this.abstractPoints.push(F.screenToAbstractCoord(i))}0===t.length&&(this.multiTouchMode=!1)}};function B(){var t=document.getElementById("myCanvas");t.width=0,t.height=0,t.width=$("#viewport").width(),t.height=$("#viewport").height(),F.width=t.width,F.height=t.height}var X=new p,F=new d;X.start();var z,V=A,J=[],_=[],G="#ff0000",U=!0,K=!0,Z={};null!==localStorage.getItem("saves")&&(Z=JSON.parse(localStorage.getItem("saves")));var Q={showHeader:!0,dotRadius:6,lineWidth:2},tt=Q;function et(t){void 0!==t.showHeader&&(tt.showHeader=t.showHeader),void 0!==t.lineWidth&&(tt.lineWidth=t.lineWidth),void 0!==t.dotRadius&&(tt.dotRadius=t.dotRadius),setHeaderVisibility(tt.showHeader),B(),nt(),ot(),localStorage.setItem("settings",JSON.stringify(tt))}function nt(){z.lineWidth=tt.lineWidth}function it(t){var e=X.copy();t(e),st(e),J=[],ot()}function st(t){X.next=t,t.previous=X,X=t,ut("autosave",!1)}function ot(){z.clearRect(0,0,z.canvas.width,z.canvas.height),z.fillStyle="#fafafa",z.fillRect(0,0,z.canvas.width,z.canvas.height),z.strokeStyle="black",X.draw(z,F,U,K);for(var n=J.length,i=0;i<n;i++)J[i].draw(z,F,new e(255,0,0));for(z.strokeStyle="lightgray",n=_.length,i=0;i<n;i++)_[i].draw(z,F,new e(190,190,190));$("#angle").val(t.round(t.toDegrees(F.angle),-6))}function rt(){F.conversionRatio=Math.min(F.width,F.height)/2-1,F.cX=0,F.cY=0,F.angle=0,ot()}null!==localStorage.getItem("settings")&&setHeaderVisibility((tt=JSON.parse(localStorage.getItem("settings"))).showHeader);var at=!1;function ct(){if(!at){var t=document.getElementById("saveDialogContents");for(var e in Z){var n=Z[e],i=document.createElement("input");i.id="saveDialogInput"+e,i.value=e,i.className="saveDialogRadio",i.setAttribute("type","radio"),i.setAttribute("name","saveDialogRadio"),i.onclick=function(){document.getElementById("saveFilename").value=this.value};var s=document.createElement("label");s.setAttribute("for","saveDialogInput"+e);var o=document.createElement("div");o.innerHTML=e;var r=document.createElement("canvas");r.height=100,r.width=100;var a=r.getContext("2d"),c=new d;c.height=100,c.width=100,c.setValues(n.converter),c.conversionRatio=100*c.conversionRatio/Math.min(n.converter.height,n.converter.width),p.fromObject(n.state).draw(a,c,!0,!1),s.appendChild(o),s.appendChild(r),t.appendChild(i),t.appendChild(s)}$(".saveDialogRadio").checkboxradio({icon:!1}),at=!0}}function lt(){at=!1;var t=document.getElementById("saveDialogContents"),e=t.cloneNode(!1);t.parentNode.replaceChild(e,t)}function ht(){return{version:"AlDraw1.0",state:X,converter:F.copy()}}function ut(t,e){var n=ht();e&&void 0!==Z[t]&&!confirm("Are you sure you want to overwrite "+t+"?")||(Z[t]=n,localStorage.setItem("saves",JSON.stringify(Z)),$("#saveDialog").dialog("close"),lt())}function dt(t){F.setValues(t.converter),st(p.fromObject(t.state)),ot()}return{converter:F,getCurrentState:function(){return X},getInputStrategy:function(){return V},setInputStrategy:function(t){J=[],_=[];for(var e=f.length,n=0;n<e;n++)f[n].name===t&&(V=f[n]);ot()},multiTouchHandler:j,settings:tt,updateSettings:et,setDefaultSettings:function(){et(Q)},setColor:function(t){G=t},setContext:function(t){z=t},getContext:function(){return z},initContext:nt,resizeCanvas:B,updateView:ot,clear:function(){var t=new p;t.start(),st(t),J=[],rt()},undo:function(){J=[],null!==X.previous&&(X=X.previous,ot())},redo:function(){J=[],null!==X.next&&(X=X.next,ot())},autoZoom:function(){F.autoZoom(X),ot()},setDefaultView:rt,zoomIn:function(){F.conversionRatio=F.conversionRatio*F.zoomAmt,ot()},zoomOut:function(){F.conversionRatio=F.conversionRatio/F.zoomAmt,ot()},setAngle:function(e){var n=Number(e);NaN!==n&&(F.angle=t.toRadians(n)),ot()},setShowLines:function(t){U=t,ot()},setShowPoints:function(t){K=t,ot()},generateSaveDialog:ct,save:ut,load:function(t){var e=Z[t];void 0===e?alert("There is no save named "+t+"."):(dt(e),$("#saveDialog").dialog("close"))},deleteSave:function(t){confirm("Are you sure you want to delete "+t+"?")&&(delete Z[t],localStorage.setItem("saves",JSON.stringify(Z)),lt(),ct())},loadFromFile:function(t){let e=new FileReader;e.readAsText(t),e.onload=function(){let t=e.result;try{var n=JSON.parse(t);!function(t){if("AlDraw1.0"!==t.version||!t.state||!t.converter)throw"Invalid save"}(n),dt(n),$("#fileInput").addClass("invisible"),$("#saveDialog").dialog("close")}catch(t){alert("That is not a valid AlDraw file")}},e.onerror=function(){console.log(e.error)}},saveAsAlDraw:function(t){var e=ht(),n=JSON.stringify(e),i=new Blob([n]),s=window.URL.createObjectURL(i),o=document.createElement("a");""===t?t="aldraw.aldraw":t.endsWith(".aldraw")||(t+=".aldraw"),o.download=t,o.href=s,o.click()},saveAsPNG:function(t){var e=document.getElementById("myCanvas"),n=document.createElement("canvas");n.width=e.width,n.height=e.height;var i=n.getContext("2d");i.lineWidth=tt.lineWidth,X.draw(i,F,U,!1);var s=n.toDataURL("image/png"),o=document.createElement("a");""===t?t="aldraw.png":t.endsWith(".png")||(t+=".png"),o.download=t,o.href=s,o.click()},saveAsSVG:function(e){function n(t){var e=F.abstractToScreenCoord(t.p1),n=F.abstractToScreenCoord(t.p2);return'<line x1="'+e.x+'" y1="'+e.y+'" x2="'+n.x+'" y2="'+n.y+'" style="stroke:#000000;"/>'}for(var i,s,o,r,a='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="'+F.width+'px" height="'+F.height+'px">',c=X.enclosures.length,l=0;l<c;l++){var h=X.enclosures[l],u=F.abstractToScreenCoord(h.path[0].startPoint());a+='<path d="M '+u.x+" "+u.y;for(var d=0;d<h.path.length;d++){var p=h.path[d];if(p.isA("Segment"))a+=" L "+(u=F.abstractToScreenCoord(p.p2)).x+" "+u.y;else if(t.floatsEqual(p.sweep,2*Math.PI)){var f=F.abstractToScreenCoord(p.getPointAtAngle(t.angleSum(p.start,Math.PI)));s=F.abstractToScreenCoord(p.getPointAtAngle(p.start)),i=F.abstractToScreenDist(p.radius),r=1,p.inverse&&(r=0),a+=" A "+i+" "+i+" 0 0 "+r+" "+f.x+" "+f.y,a+=" A "+i+" "+i+" 0 1 "+r+" "+s.x+" "+s.y}else s=F.abstractToScreenCoord(p.getPointAtAngle(p.getEnd())),i=F.abstractToScreenDist(p.radius),o=0,p.sweep>Math.PI&&(o=1),r=1,p.inverse&&(s=F.abstractToScreenCoord(p.getPointAtAngle(p.start)),r=0),a+=" A "+i+" "+i+" 0 "+o+" "+r+" "+s.x+" "+s.y}a+='" fill="'+h.color+'" fill-rule="evenodd" stroke="none"/>'}for(c=X.segments.length,l=0;l<c;l++){var g=X.segments[l];a+=n(g)}for(c=X.rays.length,l=0;l<c;l++)null!==(g=X.rays[l].getPortionInsideRectangle(F.getAbstractBoundaries()))&&(a+=n(g));for(c=X.lines.length,l=0;l<c;l++)null!==(g=X.lines[l].getPortionInsideRectangle(F.getAbstractBoundaries()))&&(a+=n(g));for(c=X.arcs.length,l=0;l<c;l++){var v=X.arcs[l],w=F.abstractToScreenCoord(v.getPointAtAngle(v.start));s=F.abstractToScreenCoord(v.getPointAtAngle(v.getEnd())),i=F.abstractToScreenDist(v.radius),o=0,v.sweep>Math.PI&&(o=1),a+='<path d="M'+w.x+" "+w.y+" A"+i+" "+i+" 0 "+o+" 1 "+s.x+" "+s.y+'" style="stroke:#000000; fill:none"/>'}for(c=X.circles.length,l=0;l<c;l++){var m=X.circles[l],y=F.abstractToScreenCoord(m.center);i=F.abstractToScreenDist(m.radius),a+='<circle cx="'+y.x+'" cy="'+y.y+'" r="'+i+'" style="stroke:#000000; fill:none"/>'}a+="</svg>";var A=new Blob([a]),I=window.URL.createObjectURL(A),P=document.createElement("a");""===e?e="aldraw.svg":e.endsWith(".svg")||(e+=".svg"),P.download=e,P.href=I,P.click()},clearUndoHistory:function(){confirm("Are you sure you want to clear all undo and redo history?")&&(X.previous=null,X.next=null)}}}();function clickModeGroup(t){$(".modeGroup").hide(),$("."+t).show(),AlDrawModule.setInputStrategy($('[name="'+t+'"]:checked').val())}function markChecked(t){document.getElementById(t).checked=!0,$(".relatedButtons").checkboxradio("refresh")}function setHeaderVisibility(t){t?$("#header").removeClass("invisible"):$("#header").addClass("invisible")}var temporarySettings=null;function openSettingsDialog(){$("#settingsDialog").dialog("open"),temporarySettings={showHeader:AlDrawModule.settings.showHeader,lineWidth:AlDrawModule.settings.lineWidth,dotRadius:AlDrawModule.settings.dotRadius},document.getElementById("showHeader").checked=temporarySettings.showHeader,document.getElementById("lineWidth").value=temporarySettings.lineWidth,document.getElementById("dotRadius").value=temporarySettings.dotRadius}function changeSettingHeader(t){AlDrawModule.updateSettings({showHeader:t.checked})}function changeSettingLineWidth(t){AlDrawModule.updateSettings({lineWidth:t.value})}function changeSettingDotRadius(t){AlDrawModule.updateSettings({dotRadius:t.value})}function cancelSettings(){AlDrawModule.updateSettings(temporarySettings),$("#settingsDialog").dialog("close")}function setDefaultSettings(){AlDrawModule.setDefaultSettings(),document.getElementById("showHeader").checked=AlDrawModule.settings.showHeader,document.getElementById("lineWidth").value=AlDrawModule.settings.lineWidth,document.getElementById("dotRadius").value=AlDrawModule.settings.dotRadius}function nextHelpPage(){document.getElementById("helpContent").scrollTop=0;var t=$(".helpPage.visible"),e=t.next();t.removeClass("visible"),t.addClass("invisible"),e.removeClass("invisible"),e.addClass("visible"),$("#prevHelpPage").button({disabled:!1}),0===e.next().length&&$("#nextHelpPage").button({disabled:!0})}function prevHelpPage(){document.getElementById("helpContent").scrollTop=0;var t=$(".helpPage.visible"),e=t.prev();t.removeClass("visible"),t.addClass("invisible"),e.removeClass("invisible"),e.addClass("visible"),$("#nextHelpPage").button({disabled:!1}),0===e.prev().length&&$("#prevHelpPage").button({disabled:!0})}$(document).ready(function(){$(document).tooltip(),$(".button").button(),$("#chooseColor").button(),$(".radioButton").checkboxradio({icon:!1}),$(".radioButtonGroup").controlgroup(),$("#saveDialog").dialog({autoOpen:!1,height:400,width:460}),$("#downloadDialog").dialog({autoOpen:!1}),$("#settingsDialog").dialog({autoOpen:!1}),$("#helpDialog").dialog({autoOpen:!1,height:400,width:500});var t=document.getElementById("myCanvas");AlDrawModule.resizeCanvas(),AlDrawModule.setContext(t.getContext("2d")),AlDrawModule.initContext(),AlDrawModule.setDefaultView(),$(window).resize(function(){AlDrawModule.resizeCanvas(),AlDrawModule.initContext(),AlDrawModule.updateView()}),$("#myCanvas").mousewheel(function(t){t.deltaY>0?AlDrawModule.converter.zoomIn(t.offsetX,t.offsetY):AlDrawModule.converter.zoomOut(t.offsetX,t.offsetY),AlDrawModule.updateView()}),$("#myCanvas").mousedown(function(t){AlDrawModule.getInputStrategy().press(t.offsetX,t.offsetY)}),$("#myCanvas").mouseup(function(t){AlDrawModule.getInputStrategy().release(t.offsetX,t.offsetY)}),$("#myCanvas").click(function(t){AlDrawModule.getInputStrategy().click(t.offsetX,t.offsetY)}),$("#myCanvas").mousemove(function(t){AlDrawModule.getInputStrategy().drag(t.offsetX,t.offsetY)});var e=function(e){var n=t.getBoundingClientRect();return{x:e.clientX-n.left,y:e.clientY-n.top}},n=function(t){for(var n=[],i=0;i<t.length;i++)n.push(e(t[i]));return n};t.addEventListener("touchstart",function(t){if(t.preventDefault(),t.stopImmediatePropagation(),1===t.touches.length){var i=e(t.touches[0]);AlDrawModule.getInputStrategy().press(i.x,i.y)}else AlDrawModule.multiTouchHandler.touchStart(n(t.touches))},{passive:!1}),t.addEventListener("touchmove",function(t){if(t.preventDefault(),t.stopImmediatePropagation(),AlDrawModule.multiTouchHandler.multiTouchMode)AlDrawModule.multiTouchHandler.touchMove(n(t.touches));else{var i=e(t.touches[0]);AlDrawModule.getInputStrategy().drag(i.x,i.y)}},{passive:!1}),t.addEventListener("touchend",function(t){if(t.preventDefault(),t.stopImmediatePropagation(),AlDrawModule.multiTouchHandler.multiTouchMode)AlDrawModule.multiTouchHandler.touchEnd(n(t.touches));else{var i=e(t.changedTouches[0]);AlDrawModule.getInputStrategy().release(i.x,i.y)}},{passive:!1}),$(document).keydown(function(t){t.ctrlKey&&32===t.which?AlDrawModule.clear():t.ctrlKey&&65===t.which?(t.preventDefault(),AlDrawModule.autoZoom()):t.ctrlKey&&(89===t.which||t.shiftKey&&90===t.which)?AlDrawModule.redo():t.ctrlKey&&90===t.which&&AlDrawModule.undo()})});